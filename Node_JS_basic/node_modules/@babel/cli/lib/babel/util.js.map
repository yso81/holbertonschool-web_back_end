{"version":3,"names":["_fsReaddirRecursive","data","require","babel","_path","_fs","watcher","asyncGeneratorStep","n","t","e","r","o","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","chmod","src","dest","fs","chmodSync","statSync","mode","_","console","warn","alphasort","b","localeCompare","readdir","dirname","includeDotfiles","filter","readdirRecursive","filename","index","currentDirectory","stat","path","join","isDirectory","startsWith","readdirForCompilable","altExts","isCompilableExtension","exts","DEFAULT_EXTENSIONS","ext","extname","includes","addSourceMappingUrl","code","loc","basename","hasDataSourcemap","pos","lastIndexOf","length","CALLER","name","supportsStaticESM","supportsDynamicImport","supportsExportNamespaceFrom","transformRepl","opts","Object","assign","sourceMaps","caller","reject","transform","err","result","compile","_x","_x2","_compile","transformFile","externalDependencies","updateExternalDependencies","deleteDir","rmSync","d","p","existsSync","readdirSync","forEach","f","lstatSync","unlinkSync","rmdirSync","force","recursive","process","on","error","exitCode","withExtension","newBasename","debounce","fn","time","timer","debounced","clearTimeout","setTimeout","flush"],"sources":["../../src/babel/util.ts"],"sourcesContent":["import readdirRecursive from \"fs-readdir-recursive\";\nimport * as babel from \"@babel/core\";\nimport path from \"node:path\";\nimport fs from \"node:fs\";\n\nimport * as watcher from \"./watcher.ts\";\n\nimport type { FileResult, InputOptions } from \"@babel/core\";\n\nexport function chmod(src: string, dest: string): void {\n  try {\n    fs.chmodSync(dest, fs.statSync(src).mode);\n  } catch (_) {\n    console.warn(`Cannot change permissions of ${dest}`);\n  }\n}\n\nexport function alphasort(a: string, b: string) {\n  return a.localeCompare(b, \"en\");\n}\n\ntype ReaddirFilter = (filename: string) => boolean;\n\nexport function readdir(\n  dirname: string,\n  includeDotfiles: boolean,\n  filter?: ReaddirFilter,\n): string[] {\n  if (process.env.BABEL_8_BREAKING) {\n    return (\n      fs\n        .readdirSync(dirname, { recursive: true, withFileTypes: true })\n        .filter(dirent => {\n          // exclude directory entries from readdir results\n          if (dirent.isDirectory()) return false;\n          const filename = dirent.name;\n          return (\n            (includeDotfiles || !filename.startsWith(\".\")) &&\n            (!filter || filter(filename))\n          );\n        })\n        .map(dirent => path.join(dirent.parentPath, dirent.name))\n        // readdirSyncRecursive conducts BFS, sort the entries so we can match the DFS behaviour of fs-readdir-recursive\n        // https://github.com/nodejs/node/blob/d6b12f5b77e35c58a611d614cf0aac674ec2c3ed/lib/fs.js#L1421\n        .sort(alphasort)\n    );\n  } else {\n    return readdirRecursive(\n      \"\",\n      (filename, index, currentDirectory) => {\n        const stat = fs.statSync(path.join(currentDirectory, filename));\n\n        // ensure we recurse into .* folders\n        if (stat.isDirectory()) return true;\n\n        return (\n          (includeDotfiles || !filename.startsWith(\".\")) &&\n          (!filter || filter(filename))\n        );\n      },\n      // @ts-expect-error improve @types/fs-readdir-recursive typings\n      [],\n      dirname,\n    );\n  }\n}\n\nexport function readdirForCompilable(\n  dirname: string,\n  includeDotfiles: boolean,\n  altExts?: string[],\n): string[] {\n  return readdir(dirname, includeDotfiles, function (filename) {\n    return isCompilableExtension(filename, altExts);\n  });\n}\n\n/**\n * Test if a filename ends with a compilable extension.\n */\nexport function isCompilableExtension(\n  filename: string,\n  altExts?: readonly string[],\n): boolean {\n  const exts = altExts || babel.DEFAULT_EXTENSIONS;\n  const ext = path.extname(filename);\n  return exts.includes(ext);\n}\n\nexport function addSourceMappingUrl(code: string, loc: string): string {\n  return code + \"\\n//# sourceMappingURL=\" + path.basename(loc);\n}\n\nexport function hasDataSourcemap(code: string): boolean {\n  const pos = code.lastIndexOf(\"\\n\", code.length - 2);\n  return pos !== -1 && code.lastIndexOf(\"//# sourceMappingURL\") < pos;\n}\n\nconst CALLER = {\n  name: \"@babel/cli\",\n  supportsStaticESM: false,\n  supportsDynamicImport: false,\n  supportsExportNamespaceFrom: false,\n};\n\nexport function transformRepl(filename: string, code: string, opts: any) {\n  opts = {\n    ...opts,\n    sourceMaps: opts.sourceMaps === \"inline\" ? true : opts.sourceMaps,\n    caller: CALLER,\n    filename,\n  };\n\n  return new Promise<FileResult>((resolve, reject) => {\n    babel.transform(code, opts, (err, result) => {\n      if (err) reject(err);\n      else resolve(result);\n    });\n  });\n}\n\nexport async function compile(filename: string, opts: InputOptions) {\n  opts = {\n    ...opts,\n    caller: CALLER,\n  };\n\n  const result = process.env.BABEL_8_BREAKING\n    ? await babel.transformFileAsync(filename, opts)\n    : await new Promise<FileResult>((resolve, reject) => {\n        babel.transformFile(filename, opts, (err, result) => {\n          if (err) reject(err);\n          else resolve(result);\n        });\n      });\n\n  if (result) {\n    if (!process.env.BABEL_8_BREAKING) {\n      if (!result.externalDependencies) return result;\n    }\n    watcher.updateExternalDependencies(filename, result.externalDependencies);\n  }\n\n  return result;\n}\n\nexport function deleteDir(path: string): void {\n  fs.rmSync(path, { force: true, recursive: true });\n}\n\nprocess.on(\"uncaughtException\", function (err) {\n  console.error(err);\n  process.exitCode = 1;\n});\n\nexport function withExtension(filename: string, ext: string = \".js\") {\n  const newBasename = path.basename(filename, path.extname(filename)) + ext;\n  return path.join(path.dirname(filename), newBasename);\n}\n\nexport function debounce(fn: () => void, time: number) {\n  let timer: NodeJS.Timeout;\n  function debounced() {\n    clearTimeout(timer);\n    timer = setTimeout(fn, time);\n  }\n  debounced.flush = () => {\n    clearTimeout(timer);\n    fn();\n  };\n  return debounced;\n}\n"],"mappings":"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","ignoreList":[]}